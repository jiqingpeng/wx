"use strict";var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var i in a)Object.prototype.hasOwnProperty.call(a,i)&&(e[i]=a[i])}return e},_index=require("./actions/index"),_index2=require("./util/index"),_lbf=require("./lbf.project");Component({properties:{},data:{user:null,showEntry:!1,isOpen:!1,ids:{},showCoupon:!1,sharer:null,couponCode:-1,needNavigate:!0,is_old_user:!1,coupon_id:"",fission_tpl:null,fission_tpl_id:""},methods:{getConfig:function(e){var d=this;return _index2.api.get(_index.actions.get.fission_config,{app_id:e}).then(function(e){wx.hideNavigationBarLoading();var t=e.data;if(Object.is(t.code,0)){var a=t.data,i=a.flaunt_switch,n=a.reminder_switch,s=a.show_team_page,r=t.data.switch||!1,o=t.data.fission_tpl_id;d.setData({isOpen:r,fission_tpl_id:o}),(0,_index2.setStorages)([{key:_index.storageKeys.team_page_status,data:s},{key:_index.storageKeys.tpl_status,data:!Object.is(o,"")},{key:_index.storageKeys.tpl_id,data:o},{key:_index.storageKeys.reminder_status,data:n},{key:_index.storageKeys.flaunt_status,data:i}])}else wx.showToast({title:t.message,icon:"none"}),d.setData({isOpen:!1})}).catch(function(e){console.error("getConfig:",e),d.setData({isOpen:!1})})},navigateTo:function(e){var t=_lbf.project.index_url||_index.indexUrl,a=e.tab||0;e.target||(t=(0,_index2.handleURL)(t,{tab:a}));var i=2;Object.is(a,0)?i=2:Object.is(a,1)&&(i=3),this.count({type:0,extra:i}),this.data.isOpen&&wx.navigateTo({url:t})},initUserInfo:function(r){var o=this;return new Promise(function(a,i){if(r&&r.target){var e=r.detail.userInfo;if(e){var t=r.target.dataset.type,n=Object.is(parseInt(t),2),s=n?o.data.ids.parent_id:"";n&&o.count({type:0,extra:1}),o.setData({user:e,needNavigate:!n},function(){o.createUser(s,n).then(function(e){return a()}).catch(function(e){return i(e)})})}}else(0,_index2.getUserInfo)({}).then(function(e){var t=e.userInfo;o.setData({user:t,needNavigate:!1},function(){o.createUser(o.data.ids.parent_id).then(function(e){return a()}).catch(function(e){return i(e)})})}).catch(function(e){console.error("获取用户信息异常，请提示用户授权"),o.setData({user:null,needNavigate:!1},function(){return i("获取用户信息异常，请提示用户授权")})})})},init:function(e){var r=this,o=arguments,d=e.open_id,_=e.user_id,u=e.parent_id,c=e.share_path,p=e.qr_url,l=e.remind_path,g=e.coupon_id,f=e.is_old_user,y=e.showEntry,x=_lbf.project.merchant_name,h=_lbf.project.version,v=_lbf.project.live_mode,m=_lbf.project.app_id,b=_lbf.project.title;return new Promise(function(t,e){var a={open_id:d,user_id:_,app_id:m,share_path:c,qr_url:p,live_mode:v,remind_path:l,merchant_name:x},i="",n=Object.keys(a).every(function(e){var t=(0,_index2.isEmpty)(a[e]);return t&&(i=e),!t});if(n){var s=[{key:_index.storageKeys.qr_url,data:p},{key:_index.storageKeys.live_mode,data:v},{key:_index.storageKeys.id,data:{open_id:d,app_id:m,user_id:_}},{key:_index.storageKeys.parent_id,data:u},{key:_index.storageKeys.title,data:b||"裂变坊"},{key:_index.storageKeys.version,data:h},{key:_index.storageKeys.project_name,data:x},{key:_index.storageKeys.is_old_user,data:f||!1},{key:_index.storageKeys.remind_path,data:l},{key:_index.storageKeys.share_path,data:c}];(0,_index2.setStorages)(s),y=!![void 0,""].includes(g)&&y,r.setData({ids:{open_id:d,app_id:m,user_id:_,parent_id:u||""},showEntry:y,coupon_id:g||"",is_old_user:f||!1},function(){(0,_index2.removeStorages)([{key:_index.storageKeys.acitvity_img_url},{key:_index.storageKeys.poster_img_url}]),r.getConfig(m).then(function(e){(0,_index2.isEmpty)(r.data.fission_tpl_id)||r.getFissionTpl(),(0,_index2.isEmpty)(u)||(0,_index2.isEmpty)(g)&&(r.getCouponStatus(_extends({is_old_user:f},r.data.ids)),r.getSharerUserInfo({user_id:r.data.ids.parent_id,app_id:m})),r.count({type:0,extra:0}),t({status:n})}),_index2.report.apply(void 0,o)})}else e({status:n,message:"参数 "+i+" 为空"})})},getCouponStatus:function(e){var i=this,t=e.is_old_user,a=(e.open_id,e.app_id),n=e.user_id,s=(e.parent_id,_index.actions.get.coupon_status.replace(":user_id",n)),r={app_id:a,user_id:n,is_old_user:t};_index2.api.get(s,r).then(function(e){var t=e.data.code;if(t=parseInt(t),Object.is(t,293)){var a=i.data.ids.parent_id;(0,_index2.isEmpty)(a)||i.initUserInfo()}i.setData({couponCode:t,showCoupon:-1<[0,279,281].indexOf(t)})}).catch(function(e){i.setData({couponCode:-1,showCoupon:!1})})},createUser:function(e,n){var s=this,t=this.data,a=t.coupon_id,i=t.ids,r=t.is_old_user,o=t.user,d=i.app_id,_=i.open_id,u=i.user_id,c={app_id:d,open_id:_,user_id:u,is_old_user:r};if(!Object.is(o,null)){var p=o.nickName,l=o.avatarUrl,g=o.gender,f=o.city,y=o.province,x=o.country;c=Object.assign({},c,{nickname:p,wechat_avatar:l,location:x+" "+y+" "+f}),Object.is(g,0)||(c.gender=Object.is(g,2)?"FEMALE":"MALE")}return(0,_index2.isEmpty)(a)||(c.coupon_id=a),(0,_index2.isEmpty)(e)||(c.parent_user_id=e),_index2.api.post(_index.actions.post.create_user,c).then(function(e){var t=e.data,a=t.code;if(Object.is(a,0))s.getUserInfo({user_id:u,app_id:d}),n?(s.setData({couponCode:-1,showCoupon:!1},function(){return wx.showToast({title:"领取成功",mask:"none",icon:"none"})}),s.count({type:1})):s.data.needNavigate&&s.navigateTo({tab:0});else{var i=Object.is(a,212)?"活动已结束，请关注后续新活动!":t.message;wx.showToast({title:i,icon:"none"}),console.error("createUser:",e)}}).catch(function(e){console.error("createUser:",e)})},getFissionTpl:function(){var a=this,e=this.data,t=e.ids,i=e.fission_tpl_id;wx.getStorageSync(_index.storageKeys.tpl_id),wx.getStorageSync(_index.storageKeys.verify_status);_index2.api.get(_index.actions.get.fission_template+"/"+i,{app_id:t.app_id}).then(function(e){var t=e.data;Object.is(t.code,0)?((0,_index2.setStorages)([{key:_index.storageKeys.need_real_name,data:t.data.need_real_name},{key:_index.storageKeys.tpl,data:t.data}]),a.setData({fission_tpl:t.data})):(a.setData({fission_tpl:null}),(0,_index2.setStorage)({key:_index.storageKeys.need_real_name,data:!1}))})},getUserInfo:function(e){var t=e.user_id,a=e.app_id;_index2.api.get(_index.actions.get.user_info+"/"+t,{app_id:a,user_id:t}).then(function(e){var t=e.data;if(Object.is(t.code,0)){var a=t.data;(0,_index2.setStorages)([{key:_index.storageKeys.user,data:a},{key:_index.storageKeys.verify_status,data:a.identify_status||!1}])}else console.error("getUser:",e)})},getSharerUserInfo:function(e){var n=this,t=e.user_id,a=e.app_id;_index2.api.get(_index.actions.get.user_info+"/"+t,{app_id:a,user_id:t}).then(function(e){var t=e.data;if(Object.is(t.code,0)){var a=t.data,i={nickname:a.nickname,avatar:a.metadata.wechat_avatar};n.setData({sharer:i,showCoupon:!0})}else console.error("getUser:",e)})},getAward:function(e){var t=0,a=0,i=0,n=Number.parseFloat(Number.isNaN(+e)?0:e),s=(0,_index2.isEmpty)(this.data.fission_tpl)?wx.getStorageSync(_index.storageKeys.tpl):this.data.fission_tpl;if((0,_index2.isEmpty)(s))console.warn("裂变坊模板配置不存在");else{var r=s.new_user_award_rule,o=s.active_user_award_rule,d=s.lying_earning_award_rule;if(!(0,_index2.isEmpty)(o)){var _=o.active_user_bounty_rule;t=this.getAmount(n,_)}if(!(0,_index2.isEmpty)(r)){var u=r.new_user_bounty_rule;a=this.getAmount(n,u)}if(!(0,_index2.isEmpty)(d)){var c=d.lying_earning_bounty_rule;i=this.getAmount(n,c)}}return{active_award:t,new_user_award:a,lying_earning_award:i}},getAmount:function(e,t){var a=0;if(Object.is(e,0))return 0;var i=t.bounty_rule_type,n=t.discount_amount,s=t.discount_amount_limit,r=t.discount_step_rule;if(Object.is(i,1))a=(0,_index2.fenToYuan)(n);else for(var o=[].concat(r).reverse(),d=0;d<o.length;d++){var _=o[d],u=_.step_amount_available,c=_.step_amount_get,p=_.step_parent_get;if(e>=(0,_index2.fenToYuan)(u)){if(Object.is(i,2))a=(0,_index2.fenToYuan)(c);else{a=Number.parseFloat((.01*p*e).toFixed(2));var l=(0,_index2.fenToYuan)(s);a=l<a?l:a}break}}return a},hideCouponMask:function(){this.setData({showCoupon:!1,sharer:null,couponCode:-1})},reportFormID:function(e){var t=e.detail,a=t.formId,i=t.target.dataset.action;(0,_index2.reportFormID)({form_id:a,type:i})},share:function(e){var t=this;(0,_index2.setStorage)({key:_index.storageKeys.merchant,data:e}).then(function(e){t.selectComponent("#merchant").updateShareStatus(!0),t.count({type:0,extra:0})})},count:function(e){var t=wx.getStorageSync(_index.storageKeys.id),a=t.app_id,i=t.user_id;(0,_index2.count)(Object.assign({app_id:a,user_id:i},e))}}});