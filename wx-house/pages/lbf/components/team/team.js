"use strict";var _index=require("../../actions/index"),_index2=require("../../util/index");Component({properties:{height:{type:String,value:"100%",observer:function(e,t){var a=parseInt(e)-20-110,n=200/355*a;this.setData({imageSize:{width:n,height:a}})}}},data:{isIPhoneX:!1,app_id:"",user_id:"",members_count:1,members_total_amount:10,show_team_qa:!1,rank:{data:[],page_number:1,page_size:10,no_more:!1,loading:!1,reload:!1},showCrown:!1},ready:function(){var n=this;(0,_index2.getSystemInfo)().then(function(e){var t=e.model,a=-1<t.indexOf("iPhone X")||-1<t.indexOf("unknown");n.setData({isIPhoneX:a})}).catch(function(e){return console.error(e)})},attached:function(){var e=this,t=wx.getStorageSync(_index.storageKeys.id),a=t.app_id,n=t.user_id;this.setData({app_id:a,user_id:n},function(){return e.getRankData(!0)})},methods:{triggerTab:function(e){this.triggerEvent("tab",{currentTab:0},{})},updateTipStatus:function(e){var t=e.currentTarget;if(t){var a=t.dataset;this.setData({show_team_qa:a.show||!1})}else this.setData({show_team_qa:!1})},getRankData:function(d){var u=this,e=this.data,t=e.app_id,a=e.user_id,_=e.rank,n=_index.actions.get.team_rank.replace(":user_id",a);if(!_.no_more||d){var g=d?1:_.page_number;this.setData({rank:Object.assign({},_,{reload:d,loading:!0})}),_index2.api.get(n,{app_id:t,user_id:a,page:g,per_page:_.page_size}).then(function(e){var t=e.data;if(wx.stopPullDownRefresh(),Object.is(t.code,0)){var a=t.data,n=a.members,i=a.members_count,o=a.members_total_amount,r=_.data,s=!d&&(0<r.length&&Object.is(n.length,0));_=s?Object.assign({},_,{noMore:!0,loading:!1}):(n=n.map(function(e){var t=e.total_amount;return t=(t/100).toFixed(2),Object.assign(e,{total_amount:t})}),r=d?n:r.concat(n),Object.assign({},_,{noMore:n.length<_.page_size,loading:!1,data:r,page_number:++g})),o=(o/100).toFixed(2),u.setData({rank:_,members_total_amount:o,members_count:i,showCrown:u.activeCrown(_.data)})}else console.warn("getRankData:",t),wx.showToast({title:t.message||"查询失败",mask:!0,icon:"none"}),u.setData({rank:Object.assign({},_,{loading:!1}),showCrown:u.activeCrown(_.data)})})}},loadMore:function(){var e=this.data.rank;e.loading||e.noMore||this.getRankData(!1)},activeCrown:function(e){for(var t=0,a=0;a<e.length;a++){if(0<e[a].total_amount&&t++,3<t)break}return 3<t}}});