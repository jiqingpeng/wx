"use strict";var _index=require("../../actions/index"),_index2=require("../../util/index");Component({properties:{size:{type:Object,value:{width:200,height:355},observer:function(e,t){var a=this.data.isIPhoneX,i=e.width,s=e.height;s=Number.parseInt(s-(a?34:0)),this.setData({imageSize:{width:Number.parseInt(i),height:s}})}},type:{type:Number,value:1,observer:function(e,t){this.setData({imageType:e})}},tip:{type:String,value:"点击空白处关闭"}},data:{loading:!1,posterImg:{loading:!1,url:"",preview:""},storageKeys:null,isIPhoneX:!1,showPreview:!1,imageType:1,imageSize:{width:206,height:366}},attached:function(){var i=this;(0,_index2.getSystemInfo)().then(function(e){var t=e.model,a=-1<t.indexOf("iPhone X")||-1<t.indexOf("unknown");i.setData({isIPhoneX:a})}).catch(function(e){return console.error(e)}),this.initStorageKeys()},detached:function(){var e=!0,t=!1,a=void 0;try{for(var i,s=this.data.storageKeys.values()[Symbol.iterator]();!(e=(i=s.next()).done);e=!0){var o=i.value;wx.removeStorageSync(o)}}catch(e){t=!0,a=e}finally{try{!e&&s.return&&s.return()}finally{if(t)throw a}}},methods:{initStorageKeys:function(){var e=this,t=new Map;[1,2].forEach(function(e){t.set(e,Object.is(e,1)?_index.storageKeys.poster_img_url:_index.storageKeys.flaunt_img_url)}),this.setData({storageKeys:t},function(){return e.initPoster(!1)})},updatePreviewStatus:function(e){var t=this,a=!!Object.is(e,!0);this.setData({showPreview:a,posterImg:Object.assign({},this.data.posterImg,{loading:a})},function(){t.triggerEvent("statuschange",{status:a},{})})},initPoster:function(e){switch(this.data.imageType){case 1:case 2:this.getPosterImg(this.data.imageType,e);break;case 3:e&&this.getMerchantPoster()}},getPosterImg:function(c,g){var d=this,h=d.data.posterImg;Object.is(h.preview,"")?d.setData({posterImg:Object.assign({},d.data.posterImg,{loading:!0,url:""})},function(){var e=wx.getStorageSync(d.data.storageKeys.get(c));if(Object.is(e,"")){var t=wx.getStorageSync(_index.storageKeys.id),a=wx.getStorageSync(_index.storageKeys.user),i=wx.getStorageSync(_index.storageKeys.qr_url),s=t.app_id,o=t.open_id,n=t.user_id,r=a?a.metadata.wechat_avatar:"";_index2.api.get(_index.actions.get.poster_img,{app_id:s,open_id:o,user_id:n,avatar:r,qrcode:i,poster_type:c}).then(function(e){var t=e.data,a=t.code,i=t.message;if(Object.is(a,0)){var s=t.data.img_url;(0,_index2.isEmpty)(s)?g&&wx.showToast({title:"商户暂未配置海报",icon:"none"}):d.setData({posterImg:Object.assign({},h,{preview:s})},function(){return(0,_index2.setStorage)({key:d.data.storageKeys.get(c),data:s})})}else console.error("getPoster:",e),g&&wx.showToast({title:i,icon:"none"})}).catch(function(e){console.error("getPoster:",e),g&&wx.showToast({title:"生成海报异常",icon:"none"})})}else d.setData({posterImg:Object.assign({},h,{preview:e,url:""})})}):d.setData({posterImg:Object.assign({},d.data.posterImg,{loading:!1,url:h.preview})})},getSaveAuth:function(a){var t=this,i=this;(0,_index2.getSetting)().then(function(e){e.authSetting["scope.writePhotosAlbum"]?i.setData({imageType:a,showPreview:!0,posterImg:Object.assign({},t.data.posterImg,{loading:!0})},function(){return i.initPoster(!0)}):(0,_index2.authorize)({scope:"scope.writePhotosAlbum"}).then(function(e){i.setData({imageType:a,showPreview:!0,posterImg:Object.assign({},t.data.posterImg,{loading:!0})},function(){return i.initPoster(!0)})}).catch(function(e){wx.showModal({content:"检测到您没打开保存图片到相册的权限，是否去设置打开？",confirmText:"确认",cancelText:"取消",success:function(e){var t=this;e.confirm&&(0,_index2.openSetting)().then(function(e){e.authSetting["scope.writePhotosAlbum"]&&i.setData({imageType:a,showPreview:!0,posterImg:Object.assign({},t.data.posterImg,{loading:!0})},function(){return i.initPoster(!0)})})}})})}).catch(function(e){console.error(e),wx.showToast({title:"获取用户设置异常",icon:"none"}),t.updatePreviewStatus(!1)})},savePosterImg:function(){var i=this,e=this.data.posterImg.url,s=this;if(Object.is(e,""))return wx.showToast({title:"下载异常，海报地址为空",mask:!0,icon:"none"});wx.showLoading({title:"下载海报中",mask:!0}),(0,_index2.downloadFile)({url:e}).then(function(e){var t=e.statusCode,a=e.tempFilePath;wx.hideLoading(),Object.is(t,200)&&(0,_index2.saveImage)({filePath:a}).then(function(e){s.updatePreviewStatus(!1),wx.showToast({title:"海报保存成功",icon:"success"}),i.reportEvent()}).catch(function(e){var t=e.errMsg;console.error("savePoster:",e),Object.is(t,"saveImageToPhotosAlbum:fail cancel")||wx.showToast({title:"保存海报异常",icon:"none"})})}).catch(function(e){wx.hideLoading(),console.error("savePoster:",e),wx.showToast({title:e.errMsg||"下载海报异常",icon:"none"})})},getMerchantPoster:function(){var o=this,e=wx.getStorageSync(_index.storageKeys.id).app_id,t=wx.getStorageSync(_index.storageKeys.merchant),a=wx.getStorageSync(_index.storageKeys.user),i={app_id:e,username:a.nickname,avatar:a.metadata.wechat_avatar,title:t.title||"",price:t.price||"",product:t.img_url||"",qrcode:t.qr_url||""},n=this.data.posterImg;this.setData({posterImg:Object.assign({},this.data.posterImg,{loading:!0,url:""})},function(){_index2.api.get(_index.actions.get.merchant_qr,i).then(function(e){var t=e.data,a=t.code,i=t.message;if(Object.is(a,0)){var s=t.data.img_url;(0,_index2.isEmpty)(s)||o.setData({posterImg:Object.assign({},n,{preview:s})})}else console.error("getMerchantPoster:",e),wx.showToast({title:i,icon:"none"})}).catch(function(e){console.error("getMerchantPoster:",e),wx.showToast({title:"商品海报生成异常",icon:"none"})})})},imgLoad:function(e){var t=this.data.posterImg;this.setData({posterImg:Object.assign({},t,{url:t.preview,loading:!1})})},imgError:function(){var e=this.data.posterImg;this.setData({posterImg:Object.assign({},e,{url:"",loading:!1})}),wx.showToast({title:"海报加载失败",mask:!0,icon:"none"})},reportFormID:function(e){var t=e.detail,a=t.formId,i=t.target.dataset.action;(0,_index2.reportFormID)({form_id:a,type:i})},reportEvent:function(){var e=wx.getStorageSync(_index.storageKeys.id),t=e.app_id,a=e.user_id,i="";switch(this.data.type){case 1:i=3;break;case 2:i=12;break;case 3:i=15}(0,_index2.count)({type:i,app_id:t,user_id:a})}}});