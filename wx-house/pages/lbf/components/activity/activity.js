"use strict";var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var i=[],a=!0,n=!1,o=void 0;try{for(var r,s=t[Symbol.iterator]();!(a=(r=s.next()).done)&&(i.push(r.value),!e||i.length!==e);a=!0);}catch(t){n=!0,o=t}finally{try{!a&&s.return&&s.return()}finally{if(n)throw o}}return i}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_index=require("../../actions/index"),_index2=require("../../util/index");Component({properties:{height:{type:String,value:"100%",observer:function(t,e){var i=parseInt(t)-35-150,a=206/366*i;this.setData({imageSize:{width:a,height:i}})}}},data:{isIPhoneX:!1,loading:!1,activityImg:{loading:!1,url:"",preview:""},tpl_status:!0,showPreview:!1,imageSize:{width:206,height:366},showBreathe:!1,showQR:!1,QRUrl:"",QRLoading:!1,needReverse:!1},attached:function(){var a=this;(0,_index2.getSystemInfo)().then(function(t){var e=t.model,i=-1<e.indexOf("iPhone X")||-1<e.indexOf("unknown");a.setData({isIPhoneX:i})}).catch(function(t){return console.error(t)}),this.getActivityImg(),this.initCard()},ready:function(){var n=this;(0,_index2.getStorages)([_index.storageKeys.tpl_status,_index.storageKeys.qr_url]).then(function(t){var e=_slicedToArray(t,2),i=e[0],a=e[1];n.setData({tpl_status:i.data,QRUrl:a.data})})},detached:function(){(0,_index2.stopAccelerometer)()},methods:{getActivityImg:function(){var r=this;r.setData({activityImg:Object.assign({},r.data.activityImg,{loading:!0,url:""})},function(){var o=r.data.activityImg,t=wx.getStorageSync(_index.storageKeys.acitvity_img_url);Object.is(t,"")?(0,_index2.getStorage)({key:_index.storageKeys.id}).then(function(t){var e=t.data.app_id;_index2.api.get(_index.actions.get.lbf_img,{app_id:e}).then(function(t){var e=t.data,i=e.code,a=e.message;if(Object.is(i,0)){var n=t.data.data.share_img_url;(0,_index2.isEmpty)(n)||r.setData({activityImg:Object.assign({},o,{preview:n})},function(){return(0,_index2.setStorage)({key:_index.storageKeys.acitvity_img_url,data:n})})}else console.error("getIntrocudc:",t),wx.showToast({title:a,icon:"none"})}).catch(function(t){console.error("getIntrocudc:",t)})}).catch(function(t){console.error("getStorage:",t)}):r.setData({activityImg:Object.assign({},o,{preview:t,url:""})})})},generatePoster:function(){this.selectComponent("#preview").getSaveAuth(1)},imgLoad:function(t){var e=t.currentTarget.dataset.type,i=this.data.activityImg;switch(e){case"0":this.setData({activityImg:Object.assign({},i,{url:i.preview,loading:!1})});break;case"1":this.setData({QRLoading:!1})}},updatePosterStatus:function(t){this.selectComponent("#preview").updatePreviewStatus(t)},imgError:function(t){var e=t.currentTarget.dataset.type,i=this.data.activityImg;switch(console.info(t),e){case"0":this.setData({activityImg:Object.assign({},i,{url:"",loading:!1})}),wx.showToast({title:"活动图片加载异常",mask:!0,icon:"none"});break;case"1":this.setData({QRUrl:"",QRLoading:!1}),wx.showToast({title:"二维码加载异常",mask:!0,icon:"none"})}},startBreathe:function(t){this.setData({showBreathe:t})},reportFormID:function(t){var e=t.detail,i=e.formId,a=e.target.dataset.action;(0,_index2.reportFormID)({form_id:i,type:a})},initCard:function(){var t=wx.getStorageSync(_index.storageKeys.id).app_id;[{type:1,key:_index.storageKeys.forward_card},{type:2,key:_index.storageKeys.reminder_card}].forEach(function(o){_index2.api.get(_index.actions.get.mini_card,{app_id:t,card_type:o.type}).then(function(t){var e=t.data,i=e.data,a=i.img_url,n=i.description;Object.is(e,null)||(0,_index2.setStorage)({key:o.key,data:{img_url:a,description:n}})})})},updateQRStatus:function(){var i=this,t=!this.data.showQR,e=wx.getStorageSync(_index.storageKeys.qr_url),a=wx.getStorageSync(_index.storageKeys.id);(0,_index2.isEmpty)(e)?wx.showToast({title:"二维码地址为空",mask:!0,icon:"none"}):(this.triggerEvent("face",{status:t},{}),this.setData({showQR:t,QRLoading:t,QRUrl:null},function(){t?(i.setData({QRUrl:e}),(0,_index2.count)({type:11,app_id:a.app_id,user_id:a.user_id}),(0,_index2.startAccelerometer)({interval:"normal"}).then(function(t){wx.onAccelerometerChange(function(t){var e=t.y;i.setData({needReverse:!(e<=0)})})}).catch(function(t){return console.error(t)})):(0,_index2.stopAccelerometer)()}))},getQRSaveAuth:function(){var e=this;(0,_index2.getSetting)().then(function(t){t.authSetting["scope.writePhotosAlbum"]?e.saveQR():(0,_index2.authorize)({scope:"scope.writePhotosAlbum"}).then(function(t){e.saveQR()}).catch(function(t){wx.showModal({content:"检测到您没打开保存图片到相册的权限，是否去设置打开？",confirmText:"确认",cancelText:"取消",success:function(t){t.confirm&&(0,_index2.openSetting)().then(function(t){t.authSetting["scope.writePhotosAlbum"]&&e.saveQR()})}})})}).catch(function(t){console.error(t),wx.showToast({title:"获取用户设置异常",icon:"none"})})},saveQR:function(){var t=this.data.QRUrl,n=this;if(Object.is(t,""))return wx.showToast({title:"下载异常，二维码地址为空",mask:!0,icon:"none"});wx.showLoading({title:"下载二维码中",mask:!0}),(0,_index2.downloadFile)({url:t}).then(function(t){var e=t.statusCode,i=t.tempFilePath;wx.hideLoading(),Object.is(e,200)&&(0,_index2.saveImage)({filePath:i}).then(function(t){n.updateQRStatus(),wx.showToast({title:"二维码保存成功",icon:"success"});var e=wx.getStorageSync(_index.storageKeys.id),i=e.app_id,a=e.user_id;(0,_index2.count)({type:13,app_id:i,user_id:a})}).catch(function(t){var e=t.errMsg;console.error("saveQR:",t),Object.is(e,"saveImageToPhotosAlbum:fail cancel")||wx.showToast({title:"保存二维码异常",icon:"none"})})}).catch(function(t){wx.hideLoading(),console.error("saveQR:",t),wx.showToast({title:t.errMsg||"保存二维码异常",icon:"none"})})}}});