"use strict";var _index=require("../../actions/index"),_index2=require("../../util/index");function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}Component({properties:{height:{type:String,value:"100%",observer:function(e,t){var a=parseInt(e)-35-150,i=206/366*a;this.setData({imageSize:{width:i,height:a}})}}},data:{sysInfo:{},isIPhoneX:!1,fix:!1,fixTop:0,incomesets:{income_earned:0,income_stay:0,income_potential:0,bounty_balance:0},canWithdrawal:!0,user_id:"",app_id:"",page_number:1,animationData:{},canRemind:!1,messageTypes:[1,2,3],emptyText:[],tabs:[{name:"潜在收益",key:"income_potential"},{name:"待收益",key:"income_stay"},{name:"总收益",key:"income_earned"}],currentTab:0,messageList:[{page_number:1,reload:!1,loading:!1,noMore:!1,data:[]},{page_number:1,reload:!1,loading:!1,noMore:!1,data:[]},{page_number:1,reload:!1,loading:!1,noMore:!1,data:[]}],showTip:!1,imageSize:{width:206,height:366},canFlaunt:!1,showVerify:!1,needVerify:!1,verifying:!1,verifyMsg:"",userName:"",idCard:"",isLyingEarning:!1},ready:function(){var i=this;(0,_index2.getSystemInfo)().then(function(e){var t=e.model,a=-1<t.indexOf("iPhone X")||-1<t.indexOf("unknown");i.setData({isIPhoneX:a})}).catch(function(e){return console.error(e)})},attached:function(){var e=wx.getStorageSync(_index.storageKeys.id),t=e.app_id,a=e.user_id,i=wx.getStorageSync(_index.storageKeys.flaunt_status),n=wx.getStorageSync(_index.storageKeys.reminder_status),s=wx.getStorageSync(_index.storageKeys.remind_path),r=wx.getStorageSync(_index.storageKeys.need_real_name),o=wx.getStorageSync(_index.storageKeys.verify_status),d=wx.getStorageSync(_index.storageKeys.team_page_status)||!1;this.setData({isLyingEarning:d,canFlaunt:i,app_id:t,user_id:a,canRemind:n&&!Object.is(s,""),needVerify:!!r&&!o}),this.initData()},methods:{initData:function(){var t=this;this.getIncome(),Object.keys(this.data.tabs).forEach(function(e){return t.getFissionMsg(!0,e)})},checkVerify:function(){var e=this.data.needVerify;if(this.data.incomesets.bounty_balance<1)return wx.showModal({title:"暂不能提现",content:"余额大于等于 1 元即可提现",showCancel:!1});e?this.setData({showVerify:!0}):this.withdrawal()},updateField:function(e){var t=e.target.dataset.type,a=(""+e.detail.value).trim();this.setData(_defineProperty({},t,a))},checkUserInfo:function(){var e=this,t=this.data,a=t.userName,i=t.idCard;i=(""+i).trim(),a=(""+a).trim();var n="";Object.is(a,"")?n="请输入姓名":/^[\u4e00-\u9fa5][\u4e00-\u9fa5·]+$/g.test(a)?Object.is(i,"")?n="请输入身份证号码":/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/g.test(i)||(n="请输入正确格式的身份证号码"):n="请输入正确格式的姓名",this.setData({userName:a,idCard:i,verifyMsg:n},function(){Object.is(n,"")&&e.verify()})},hideVerify:function(){this.setData({showVerify:!1,userName:"",idCard:"",verifyMsg:""})},withdrawal:function(){var a=this,e=this.data,t=e.app_id,i=e.user_id,n=e.incomesets,s=(100*n.bounty_balance).toFixed(0);_index2.api.post(_index.actions.get.bounty_withdrawal,{app_id:t,user_id:i,amount:s,description:"提现 "+n.bounty_balance+" 元",order_no:(0,_index2.createOrderId)()}).then(function(e){if(0===e.data.code){wx.showModal({title:"申请成功",content:"可稍后至微信零钱确认提现结果",showCancel:!1});var t=Object.assign({},a.data.incomesets,{bounty_balance:(0).toFixed(2)});a.setData({incomesets:t})}else wx.showModal({title:"申请失败",content:"请稍后重试",showCancel:!1})})},generatePoster:function(){this.selectComponent("#preview").getSaveAuth(2)},updatePreviewStatus:function(e){this.selectComponent("#preview").updatePreviewStatus(e)},resetMessagelist:function(){this.setData({messageList:[{page_number:1,loading:!1,noMore:!1,data:[]},{page_number:1,loading:!1,noMore:!1,data:[]},{page_number:1,loading:!1,noMore:!1,data:[]}]})},loadMore:function(){var e=this.data,t=e.messageList[e.currentTab];t.loading||t.noMore||this.getFissionMsg(!1,this.data.currentTab)},initEmptyText:function(){var e={empty:{text:"暂无好友领取你的优惠券，快去分享吧",action:"去分享",src:"../../assets/imgs/no-coupon.svg",actionType:1},remind:{text:"暂无好友使用你的优惠券",action:"催催 TA",src:"../../assets/imgs/no-coupon.svg",actionType:2},wait:{text:"您的收益还在路上",action:"继续去赚钱",src:"../../assets/imgs/money.svg",actionType:3}},t=this.data.messageList,a="",i=[];i.push(e.empty),a=0<t[0].data.length?e.remind:e.empty,i.push(a),a=0<t[1].data.length?e.wait:0<t[0].data.length?e.remind:e.empty,i.push(a),this.setData({emptyText:i})},getFissionTpl:function(){var i=this,e=wx.getStorageSync(_index.storageKeys.tpl_id),n=wx.getStorageSync(_index.storageKeys.verify_status);_index2.api.get(_index.actions.get.fission_template+"/"+e,{app_id:this.data.app_id}).then(function(e){var t=e.data;if(Object.is(t.code,0)){var a=t.data;i.setData({needVerify:!!a.need_real_name&&!n})}})},getFissionMsg:function(s,r){var o=this,e=this.data,t=e.app_id,a=e.user_id,i=e.messageTypes,d=e.messageList,c=d[r];if(!c.noMore||s){var u=s?1:c.page_number;d[r]=Object.assign({},c,{reload:s,loading:!0}),this.setData({messageList:d}),_index2.api.get(_index.actions.get.fission_message,{msg_type:i[r],page_number:u,app_id:t,user_id:a}).then(function(e){var t=e.data;if(Object.is(t.code,0)){var a=t.data,i=c.data,n=!s&&(0<i.length&&Object.is(a.length,0));d[r]=n?Object.assign({},c,{noMore:!0,loading:!1}):(i=s?a:i.concat(a),i=o.handleMessage(i),Object.assign({},c,{noMore:a.length<10,loading:!1,data:i,page_number:++u})),o.setData({messageList:d},function(){return o.initEmptyText()})}else console.warn("getFissionMsg:",t),wx.showToast({title:t.data.message||"查询失败",mask:!0,icon:"none"}),d[r]=Object.assign({},c,{loading:!0}),o.setData({messageList:d},function(){return o.initEmptyText()})})}},getIncome:function(){var i=this;_index2.api.get(_index.actions.get.bounty_statistics,{app_id:this.data.app_id,user_id:this.data.user_id}).then(function(e){if(wx.stopPullDownRefresh(),0===e.data.code){var t=e.data.data,a={income_earned:t.income_earned,income_stay:t.income_stay,income_potential:t.income_potential,bounty_balance:t.bounty_balance};Object.keys(a).forEach(function(e){var t=a[e];t/=100,a[e]=t.toFixed(2)}),i.setData({incomesets:a})}})},handleMessage:function(e){this.data.currentTab;return e.map(function(e){var t=e.bounty_transaction,a=e.reminder,i=!0;if(e.hasOwnProperty("haveRemined"))return e;if(a){var n=t.last_reminder_time;i=![null,""].includes(n)&&!!(0,_index2.isToday)(n)}return Object.assign({},e,{haveRemined:i})})},changeTab:function(e){var t=+e.currentTarget.id;Object.is(this.data.currentTab,t)||this.setData({currentTab:t})},triggerTab:function(e){var t=e.currentTarget.dataset.type;Object.is(t,2)?this.setData({currentTab:0}):this.triggerEvent("tab",{currentTab:0},{})},remind:function(a,e){var i=this,t=e.app_id,n=e.user_id,s=e.bt_id;_index2.api.post(_index.actions.post.remind,{app_id:t,user_id:n,bt_id:s}).then(function(e){var t=e.data;Object.is(t.code,0)?i.updateMessageStatus(a):wx.showToast({title:t.message||"状态更新异常",icon:"none",mask:!0})}).catch(function(e){console.error("remind:",e)})},updateMessageStatus:function(i){var e=this.data,t=e.messageList,a=e.currentTab,n=t[a],s=n.data.map(function(e,t){var a=Object.assign({},e);return Object.is(t,+i)&&(a.haveRemined=!0),a});t[a]=Object.assign({},n,{data:s}),this.setData({messageList:t})},updateTipStatus:function(e){var t=e.currentTarget;if(t){var a=t.dataset;this.setData({showTip:a.show||!1})}else this.setData({showTip:!1})},reportFormID:function(e){var t=e.detail,a=t.formId,i=t.target.dataset.action;(0,_index2.reportFormID)({form_id:a,type:i})},updatePosterStatus:function(e){this.selectComponent("#preview").updatePreviewStatus(e)},verify:function(){var a=this,e=this.data,t=e.app_id,i=e.user_id,n=e.userName,s=e.idCard;this.setData({verifying:!0}),_index2.api.post(_index.actions.post.verify,{app_id:t,user_id:i,name:n,id_number:s}).then(function(e){var t=e.data;Object.is(t.code,0)?((0,_index2.setStorage)({key:_index.storageKeys.verify_status,data:!0}),wx.showToast({title:"认证成功",mask:!0,icon:"none",complete:function(){a.setData({needVerify:!1,userName:"",idCard:"",verifying:!1,showVerify:!1},function(){a.withdrawal()})}})):(a.setData({verifying:!1}),wx.showModal({title:"提示",content:t.message||"认证异常，请稍后重试",showCancel:!1}))})}}});